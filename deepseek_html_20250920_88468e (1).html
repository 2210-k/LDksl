<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Стабильность Банк & Такси</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }
        h1, h2, h3, h4 {
            margin-top: 0;
        }
        .main-tabs {
            display: flex;
            margin-bottom: 20px;
            background-color: #eee;
            border-radius: 8px;
            overflow: hidden;
        }
        .main-tab {
            padding: 15px 20px;
            flex: 1;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .main-tab.active {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .players-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .player-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #f9f9f9;
            position: relative;
        }
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .player-name {
            font-weight: bold;
            font-size: 18px;
        }
        .player-passport {
            color: #666;
            font-size: 14px;
        }
        .balance {
            font-size: 20px;
            margin: 10px 0;
        }
        .positive {
            color: #27ae60;
        }
        .negative {
            color: #e74c3c;
        }
        .fines, .loans {
            margin: 8px 0;
            padding: 5px;
            border-radius: 4px;
            background-color: #fff3f3;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            cursor: pointer;
            padding: 5px;
            background-color: #eee;
            border-radius: 4px;
        }
        .history {
            margin-top: 5px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        .history.hidden {
            display: none;
        }
        .history-item {
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        .admin-panel {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border: 1px solid #ddd;
            display: none;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 20px;
            background-color: #eee;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .tab.active {
            background-color: #3498db;
            color: white;
        }
        .edit-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: auto;
            padding: 8px 15px;
            background-color: #2ecc71;
        }
        .repay-all-btn {
            padding: 5px 10px;
            font-size: 12px;
            margin-top: 5px;
            width: auto;
            background-color: #e67e22;
        }
        .clear-history-btn {
            padding: 5px 10px;
            font-size: 12px;
            margin-top: 5px;
            width: auto;
            background-color: #e74c3c;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .action-buttons button {
            flex: 1;
            padding: 8px;
            font-size: 14px;
        }
        .toggle-history-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 18px;
            margin: 0;
            padding: 0 5px;
        }
        
        /* Такси стили */
        .taxi-section {
            margin-top: 20px;
        }
        .taxi-tabs {
            display: flex;
            margin-bottom: 20px;
            background-color: #eee;
            border-radius: 8px;
            overflow: hidden;
        }
        .taxi-tab {
            padding: 15px 20px;
            flex: 1;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .taxi-tab.active {
            background-color: #f39c12;
            color: white;
            font-weight: bold;
        }
        .shift-form, .call-item, .dispatcher-call {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
        }
        .call-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .call-actions button {
            flex: 1;
        }
        .active-shift {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #4caf50;
        }
        .completed-call {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #4caf50;
        }
        .high-salary {
            color: #e74c3c;
            font-weight: bold;
        }
        .driver-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .driver-item {
            background-color: #f0f7ff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid #cce5ff;
        }
        .call-form {
            background-color: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #ffcc80;
        }
        .active-calls {
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status-assigned {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        .status-approved {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .check-shift-btn {
            background-color: #95a5a6;
            width: auto;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Стабильность Банк & Такси</h1>
            <p>Ваш надежный финансовый и транспортный партнер</p>
            <button class="edit-btn" id="toggleEditBtn">Редактировать</button>
        </header>

        <div class="main-tabs">
            <div class="main-tab active" data-tab="bank">Банковская система</div>
            <div class="main-tab" data-tab="taxi">Такси</div>
        </div>

        <div class="tab-content active" id="bank">
            <h2>Клиенты банка</h2>
            <div class="players-container" id="playersContainer">
                <!-- Здесь будут отображаться карточки игроков -->
            </div>

            <div class="admin-panel" id="adminPanel">
                <div class="tabs">
                    <div class="tab active" data-tab="addPlayer">Добавить клиента</div>
                    <div class="tab" data-tab="removePlayer">Удалить клиента</div>
                    <div class="tab" data-tab="manageFinance">Управление финансами</div>
                </div>

                <div class="tab-content active" id="addPlayer">
                    <h3>Добавление нового клиента</h3>
                    <div class="form-group">
                        <label for="adminPasswordAdd">Пароль администратора</label>
                        <input type="password" id="adminPasswordAdd" placeholder="Введите пароль">
                    </div>
                    <div class="form-group">
                        <label for="playerName">Имя</label>
                        <input type="text" id="playerName" placeholder="Введите имя">
                    </div>
                    <div class="form-group">
                        <label for="playerMiddleName">Отчество</label>
                        <input type="text" id="playerMiddleName" placeholder="Введите отчество">
                    </div>
                    <div class="form-group">
                        <label for="playerPassport">Паспортные данные</label>
                        <input type="text" id="playerPassport" placeholder="Серия и номер паспорта">
                    </div>
                    <button onclick="addPlayer()">Добавить клиента</button>
                </div>

                <div class="tab-content" id="removePlayer">
                    <h3>Удаление клиента</h3>
                    <div class="form-group">
                        <label for="adminPasswordRemove">Пароль администратора</label>
                        <input type="password" id="adminPasswordRemove" placeholder="Введите пароль">
                    </div>
                    <div class="form-group">
                        <label for="playerToRemove">Выберите клиента для удаления</label>
                        <select id="playerToRemove">
                            <option value="">-- Выберите клиента --</option>
                        </select>
                    </div>
                    <button onclick="removePlayer()">Удалить клиента</button>
                </div>

                <div class="tab-content" id="manageFinance">
                    <h3>Управление финансами клиента</h3>
                    <div class="form-group">
                        <label for="adminPasswordFinance">Пароль администратора</label>
                        <input type="password" id="adminPasswordFinance" placeholder="Введите пароль">
                    </div>
                    <div class="form-group">
                        <label for="selectedPlayer">Выберите клиента</label>
                        <select id="selectedPlayer">
                            <option value="">-- Выберите клиента --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="operationType">Тип операции</label>
                        <select id="operationType">
                            <option value="deposit">Пополнение счета</option>
                            <option value="withdraw">Снятие со счета</option>
                            <option value="fine">Наложить штраф</option>
                            <option value="loan">Выдать кредит</option>
                            <option value="loanRepayment">Погашение кредита</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="amount">Сумма</label>
                        <input type="number" id="amount" placeholder="Введите сумму">
                    </div>
                    <div class="form-group">
                        <label for="description">Описание</label>
                        <input type="text" id="description" placeholder="Введите описание операции">
                    </div>
                    <button onclick="performFinancialOperation()">Выполнить операцию</button>
                </div>
            </div>
        </div>

        <div class="tab-content" id="taxi">
            <div class="taxi-tabs">
                <div class="taxi-tab active" data-tab="driver">Панель таксиста</div>
                <div class="taxi-tab" data-tab="dispatcher">Диспетчерская</div>
            </div>

            <div class="tab-content active" id="driver">
                <div class="shift-form" id="shiftForm">
                    <h3>Начать смену</h3>
                    <div class="form-group">
                        <label for="driverName">Имя</label>
                        <input type="text" id="driverName" placeholder="Введите имя">
                    </div>
                    <div class="form-group">
                        <label for="driverMiddleName">Отчество</label>
                        <input type="text" id="driverMiddleName" placeholder="Введите отчество">
                    </div>
                    <div class="form-group">
                        <label for="driverPassport">Паспортные данные</label>
                        <input type="text" id="driverPassport" placeholder="Серия и номер паспорта">
                        <button class="check-shift-btn" onclick="checkShift()">Проверить активную смену</button>
                    </div>
                    <div class="form-group">
                        <label for="carType">Тип автомобиля</label>
                        <select id="carType">
                            <option value="personal">Личный автомобиль</option>
                            <option value="company">Автомобиль таксопарка</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="carBrand">Марка автомобиля</label>
                        <input type="text" id="carBrand" placeholder="Введите марку">
                    </div>
                    <div class="form-group">
                        <label for="carModel">Модель автомобиля</label>
                        <input type="text" id="carModel" placeholder="Введите модель">
                    </div>
                    <div class="form-group">
                        <label for="carColor">Цвет автомобиля</label>
                        <input type="text" id="carColor" placeholder="Введите цвет">
                    </div>
                    <div class="form-group">
                        <label for="carNumber">Госномер автомобиля</label>
                        <input type="text" id="carNumber" placeholder="Введите госномер">
                    </div>
                    <button onclick="startShift()">Начать смену</button>
                </div>

                <div class="active-shift" id="activeShift" style="display: none;">
                    <h3>Активная смена</h3>
                    <div id="shiftInfo"></div>
                    <button onclick="endShift()" style="background-color: #e74c3c;">Завершить смену</button>
                    
                    <h4>Текущие вызовы</h4>
                    <div id="activeCallsList"></div>
                    
                    <h4>История вызовов</h4>
                    <div id="callsHistory"></div>
                </div>
            </div>

            <div class="tab-content" id="dispatcher">
                <div class="form-group">
                    <label for="dispatcherPassword">Пароль диспетчера</label>
                    <input type="password" id="dispatcherPassword" placeholder="Введите пароль">
                    <button onclick="authDispatcher()">Авторизоваться</button>
                </div>

                <div id="dispatcherPanel" style="display: none;">
                    <h3>Панель диспетчера</h3>
                    
                    <div class="driver-list">
                        <h4>Таксисты на смене</h4>
                        <div id="driversOnShift"></div>
                    </div>
                    
                    <div class="call-form">
                        <h4>Создать вызов</h4>
                        <button onclick="generateCall()">Сгенерировать вызов</button>
                        <div class="form-group">
                            <label for="callerName">Имя клиента</label>
                            <input type="text" id="callerName" readonly>
                        </div>
                        <div class="form-group">
                            <label for="fromAddress">Откуда</label>
                            <input type="text" id="fromAddress" readonly>
                        </div>
                        <div class="form-group">
                            <label for="toAddress">Куда</label>
                            <input type="text" id="toAddress" readonly>
                        </div>
                        <div class="form-group">
                            <label for="callSalary">Зарплата</label>
                            <input type="text" id="callSalary" readonly>
                        </div>
                        <div class="form-group">
                            <label for="assignDriver">Назначить таксиста</label>
                            <select id="assignDriver">
                                <option value="">Выберите таксиста</option>
                            </select>
                        </div>
                        <button onclick="createCall()">Создать вызов</button>
                    </div>
                    
                    <div class="active-calls">
                        <h4>Активные вызовы</h4>
                        <div id="dispatcherCallsList"></div>
                    </div>
                    
                    <div class="completed-calls">
                        <h4>Завершенные вызовы (ожидают подтверждения)</h4>
                        <div id="completedCallsList"></div>
                    </div>

                    <div class="approved-calls">
                        <h4>История вызовов</h4>
                        <div id="approvedCallsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Константы
        const ADMIN_PASSWORD = "121212";
        const DISPATCHER_PASSWORD = "121212";
        
        // Данные игроков
        let players = JSON.parse(localStorage.getItem('bankPlayers')) || [];
        
        // Данные такси
        let taxiData = JSON.parse(localStorage.getItem('taxiData')) || {
            shifts: [],
            calls: [],
            activeDrivers: []
        };
        
        // Случайные имена для клиентов такси
        const clientNames = [
            "Иван Иванов", "Петр Петров", "Сергей Сергеев", "Алексей Алексеев", 
            "Мария Смирнова", "Анна Иванова", "Екатерина Петрова", "Ольга Сидорова",
            "Дмитрий Козлов", "Андрей Новиков", "Николай Морозов", "Владимир Волков",
            "Елена Кузнецова", "Наталья Соколова", "Ирина Попова", "Светлана Лебедева"
        ];
        
        // Адреса для такси
        const addresses = [
            { street: "Тюльпанная", houses: Array.from({length: 20}, (_, i) => (i + 1).toString()), isBorder: false },
            { street: "Абрикосовая", houses: ["10", "12", "14", "15"], isBorder: false },
            { street: "Полевая", houses: ["1/3", "1/2", "1/1"], isBorder: false },
            { street: "Васильковая", houses: ["21", "32", "34", "7", "36", "23", "25", "27", "29", "31", "33", "35", "37", "39", "50", "46", "44", "42", "40", "38", "36", "36А"], isBorder: false },
            { street: "Цветочная", houses: ["42", "43", "43А", "44", "45", "46", "47", "48", "49", "50", "51", "52", "53", "54", "55", "56", "57", "58", "60", "62"], isBorder: true }
        ];

        // Текущий сгенерированный вызов
        let currentGeneratedCall = null;
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            renderPlayers();
            updatePlayerDropdowns();
            setupTabs();
            setupMainTabs();
            generateCall();
            updateDriverDropdown();
            
            // Настройка кнопки редактирования
            document.getElementById('toggleEditBtn').addEventListener('click', function() {
                const adminPanel = document.getElementById('adminPanel');
                if (adminPanel.style.display === 'block') {
                    adminPanel.style.display = 'none';
                    this.textContent = 'Редактировать';
                } else {
                    adminPanel.style.display = 'block';
                    this.textContent = 'Скрыть панель';
                }
            });
            
            // Проверяем активную смену
            checkStoredShift();
        });
        
        // Настройка основных вкладок (Банк/Такси)
        function setupMainTabs() {
            const mainTabs = document.querySelectorAll('.main-tab');
            mainTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Убираем активный класс у всех вкладок и контента
                    document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Добавляем активный класс к выбранной вкладке и соответствующему контенту
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
            
            // Настройка вкладок такси
            const taxiTabs = document.querySelectorAll('.taxi-tab');
            taxiTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    if (tab.dataset.tab === 'dispatcher') {
                        const password = prompt('Введите пароль диспетчера:');
                        if (password !== DISPATCHER_PASSWORD) {
                            alert('Неверный пароль диспетчера!');
                            return;
                        } else {
                            document.getElementById('dispatcherPanel').style.display = 'block';
                            updateDriversList();
                            updateDispatcherCalls();
                        }
                    }
                    
                    // Убираем активный класс у всех вкладок такси
                    document.querySelectorAll('.taxi-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#taxi .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Добавляем активный класс к выбранной вкладке
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
        }
        
        // Настройка вкладок
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Убираем активный класс у всех вкладок и контента
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Добавляем активный класс к выбранной вкладке и соответствующему контенту
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
        }
        
        // Обновление выпадающих списков с игроками
        function updatePlayerDropdowns() {
            const removeDropdown = document.getElementById('playerToRemove');
            const financeDropdown = document.getElementById('selectedPlayer');
            
            // Очищаем dropdowns
            removeDropdown.innerHTML = '<option value="">-- Выберите клиента --</option>';
            financeDropdown.innerHTML = '<option value="">-- Выберите клиента --</option>';
            
            // Заполняем dropdowns
            players.forEach(player => {
                const option = document.createElement('option');
                option.value = player.passport;
                option.textContent = `${player.name} ${player.middleName} (${player.passport})`;
                
                removeDropdown.appendChild(option.cloneNode(true));
                financeDropdown.appendChild(option.cloneNode(true));
            });
        }
        
        // Отображение игроков
        function renderPlayers() {
            const container = document.getElementById('playersContainer');
            container.innerHTML = '';
            
            if (players.length === 0) {
                container.innerHTML = '<p>Нет добавленных клиентов</p>';
                return;
            }
            
            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                
                // Проверяем, есть ли свойство historyHidden у игрока
                if (player.historyHidden === undefined) {
                    player.historyHidden = false;
                }
                
                playerCard.innerHTML = `
                    <div class="player-header">
                        <div>
                            <div class="player-name">${player.name} ${player.middleName}</div>
                            <div class="player-passport">Паспорт: ${player.passport}</div>
                        </div>
                    </div>
                    <div class="balance ${player.balance >= 0 ? 'positive' : 'negative'}">
                        Баланс: ${player.balance} ₽
                    </div>
                    <div class="fines">
                        Штрафы: ${player.fines} ₽
                        ${player.fines > 0 ? `<button class="repay-all-btn" onclick="repayAllFines('${player.passport}')">Погасить все штрафы</button>` : ''}
                    </div>
                    <div class="loans">
                        Кредиты: ${player.loans} ₽
                        ${player.loans > 0 ? `<button class="repay-all-btn" onclick="repayAllLoans('${player.passport}')">Погасить все кредиты</button>` : ''}
                    </div>
                    <div class="history-header" onclick="toggleHistory('${player.passport}')">
                        <h4>История операций</h4>
                        <button class="toggle-history-btn">${player.historyHidden ? '▼' : '▲'}</button>
                    </div>
                    <div class="history ${player.historyHidden ? 'hidden' : ''}">
                        ${player.history.length ? 
                            player.history.map(record => 
                                `<div class="history-item">${record.date}: ${record.amount} ₽ - ${record.description}</div>`
                            ).join('') : 
                            '<div>Нет операций</div>'
                        }
                        ${player.history.length > 0 ? 
                            `<button class="clear-history-btn" onclick="clearHistory('${player.passport}')">Очистить историю</button>` : 
                            ''
                        }
                    </div>
                `;
                
                container.appendChild(playerCard);
            });
        }
        
        // Переключение отображения истории
        function toggleHistory(passport) {
            const player = players.find(p => p.passport === passport);
            if (player) {
                player.historyHidden = !player.historyHidden;
                savePlayers();
                renderPlayers();
            }
        }
        
        // Очистка истории клиента
        function clearHistory(passport) {
            const password = prompt('Введите пароль администратора:');
            if (password !== ADMIN_PASSWORD) {
                alert('Неверный пароль администратора!');
                return;
            }
            
            const player = players.find(p => p.passport === passport);
            if (!player) {
                alert('Клиент не найден!');
                return;
            }
            
            if (player.history.length === 0) {
                alert('История операций клиента уже пуста!');
                return;
            }
            
            if (confirm('Вы уверены, что хотите очистить всю историю операций этого клиента?')) {
                player.history = [];
                savePlayers();
                renderPlayers();
                alert('История операций успешно очищена!');
            }
        }
        
        // Проверка пароля администратора
        function checkAdminPassword(passwordInputId) {
            const password = document.getElementById(passwordInputId).value;
            if (password !== ADMIN_PASSWORD) {
                alert('Неверный пароль администратора!');
                return false;
            }
            return true;
        }
        
        // Добавление игрока
        function addPlayer() {
            if (!checkAdminPassword('adminPasswordAdd')) return;
            
            const name = document.getElementById('playerName').value;
            const middleName = document.getElementById('playerMiddleName').value;
            const passport = document.getElementById('playerPassport').value;
            
            if (!name || !middleName || !passport) {
                alert('Заполните все поля!');
                return;
            }
            
            // Проверяем, нет ли уже игрока с таким паспортом
            if (players.some(player => player.passport === passport)) {
                alert('Клиент с такими паспортными данными уже существует!');
                return;
            }
            
            // Добавляем нового игрока
            const newPlayer = {
                name,
                middleName,
                passport,
                balance: 0,
                fines: 0,
                loans: 0,
                history: [],
                historyHidden: false
            };
            
            players.push(newPlayer);
            savePlayers();
            renderPlayers();
            updatePlayerDropdowns();
            
            // Очищаем форму
            document.getElementById('playerName').value = '';
            document.getElementById('playerMiddleName').value = '';
            document.getElementById('playerPassport').value = '';
            
            alert('Клиент успешно добавлен!');
        }
        
        // Удаление игрока
        function removePlayer() {
            if (!checkAdminPassword('adminPasswordRemove')) return;
            
            const passport = document.getElementById('playerToRemove').value;
            
            if (!passport) {
                alert('Выберите клиента для удаления!');
                return;
            }
            
            if (confirm('Вы уверены, что хотите удалить этого клиента?')) {
                players = players.filter(player => player.passport !== passport);
                savePlayers();
                renderPlayers();
                updatePlayerDropdowns();
                alert('Клиент успешно удален!');
            }
        }
        
        // Выполнение финансовой операции
        function performFinancialOperation() {
            if (!checkAdminPassword('adminPasswordFinance')) return;
            
            const passport = document.getElementById('selectedPlayer').value;
            const operationType = document.getElementById('operationType').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value;
            
            if (!passport) {
                alert('Выберите клиента!');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('Введите корректную сумму!');
                return;
            }
            
            if (!description) {
                alert('Введите описание операции!');
                return;
            }
            
            const player = players.find(p => p.passport === passport);
            if (!player) {
                alert('Клиент не найден!');
                return;
            }
            
            // Выполняем операцию в зависимости от типа
            switch(operationType) {
                case 'deposit':
                    player.balance += amount;
                    player.history.unshift({
                        date: new Date().toLocaleString(),
                        amount: +amount,
                        description: description
                    });
                    break;
                    
                case 'withdraw':
                    if (player.balance < amount) {
                        alert('Недостаточно средств на счете!');
                        return;
                    }
                    player.balance -= amount;
                    player.history.unshift({
                        date: new Date().toLocaleString(),
                        amount: -amount,
                        description: description
                    });
                    break;
                    
                case 'fine':
                    player.fines += amount;
                    player.history.unshift({
                        date: new Date().toLocaleString(),
                        amount: -amount,
                        description: `Штраф: ${description}`
                    });
                    break;
                    
                case 'loan':
                    player.loans += amount;
                    player.balance += amount;
                    player.history.unshift({
                        date: new Date().toLocaleString(),
                        amount: +amount,
                        description: `Кредит: ${description}`
                    });
                    break;
                    
                case 'loanRepayment':
                    if (player.loans < amount) {
                        alert('Сумма погашения превышает сумму кредита!');
                        return;
                    }
                    if (player.balance < amount) {
                        alert('Недостаточно средств для погашения кредита!');
                        return;
                    }
                    player.loans -= amount;
                    player.balance -= amount;
                    player.history.unshift({
                        date: new Date().toLocaleString(),
                        amount: -amount,
                        description: `Погашение кредита: ${description}`
                    });
                    break;
            }
            
            savePlayers();
            renderPlayers();
            
            // Очищаем форму
            document.getElementById('amount').value = '';
            document.getElementById('description').value = '';
            
            alert('Операция выполнена успешно!');
        }
        
        // Погашение всех штрафов
        function repayAllFines(passport) {
            const password = prompt('Введите пароль администратора:');
            if (password !== ADMIN_PASSWORD) {
                alert('Неверный пароль администратора!');
                return;
            }
            
            const player = players.find(p => p.passport === passport);
            if (!player) {
                alert('Клиент не найден!');
                return;
            }
            
            if (player.fines <= 0) {
                alert('У клиента нет штрафов для погашения!');
                return;
            }
            
            if (player.balance < player.fines) {
                alert('Недостаточно средств для погашения всех штрафов!');
                return;
            }
            
            if (confirm(`Погасить все штрафы на сумму ${player.fines} ₽?`)) {
                player.balance -= player.fines;
                player.history.unshift({
                    date: new Date().toLocaleString(),
                    amount: -player.fines,
                    description: 'Погашение всех штрафов'
                });
                player.fines = 0;
                
                savePlayers();
                renderPlayers();
                alert('Все штрафы успешно погашены!');
            }
        }
        
        // Погашение всех кредитов
        function repayAllLoans(passport) {
            const password = prompt('Введите пароль администратора:');
            if (password !== ADMIN_PASSWORD) {
                alert('Неверный пароль администратора!');
                return;
            }
            
            const player = players.find(p => p.passport === passport);
            if (!player) {
                alert('Клиент не найден!');
                return;
            }
            
            if (player.loans <= 0) {
                alert('У клиента нет кредитов для погашения!');
                return;
            }
            
            if (player.balance < player.loans) {
                alert('Недостаточно средств для погашения всех кредитов!');
                return;
            }
            
            if (confirm(`Погасить все кредиты на сумму ${player.loans} ₽?`)) {
                player.balance -= player.loans;
                player.history.unshift({
                    date: new Date().toLocaleString(),
                    amount: -player.loans,
                    description: 'Погашение всех кредитов'
                });
                player.loans = 0;
                
                savePlayers();
                renderPlayers();
                alert('Все кредиты успешно погашены!');
            }
        }
        
        // Сохранение данных в localStorage
        function savePlayers() {
            localStorage.setItem('bankPlayers', JSON.stringify(players));
        }
        
        function saveTaxiData() {
            localStorage.setItem('taxiData', JSON.stringify(taxiData));
        }
        
        // ===== ТАКСИ ФУНКЦИИ =====
        
        // Проверить активную смену
        function checkShift() {
            const passport = document.getElementById('driverPassport').value;
            if (!passport) {
                alert('Введите паспортные данные для проверки');
                return;
            }
            
            const activeDriver = taxiData.activeDrivers.find(d => d.passport === passport);
            if (activeDriver) {
                // Заполняем форму данными из активной смены
                document.getElementById('driverName').value = activeDriver.name;
                document.getElementById('driverMiddleName').value = activeDriver.middleName;
                document.getElementById('carType').value = activeDriver.carType;
                document.getElementById('carBrand').value = activeDriver.carBrand;
                document.getElementById('carModel').value = activeDriver.carModel;
                document.getElementById('carColor').value = activeDriver.carColor;
                document.getElementById('carNumber').value = activeDriver.carNumber;

                // Скрываем форму и показываем активную смену
                document.getElementById('shiftForm').style.display = 'none';
                document.getElementById('activeShift').style.display = 'block';

                // Обновляем информацию о смене
                document.getElementById('shiftInfo').innerHTML = `
                    <p><strong>Таксист:</strong> ${activeDriver.name} ${activeDriver.middleName}</p>
                    <p><strong>Паспорт:</strong> ${activeDriver.passport}</p>
                    <p><strong>Автомобиль:</strong> ${activeDriver.carBrand} ${activeDriver.carModel}, ${activeDriver.carColor}, ${activeDriver.carNumber}</p>
                    <p><strong>Начало смены:</strong> ${activeDriver.startTime}</p>
                `;

                updateDriverCalls();
            } else {
                alert('Активная смена не найдена для данного паспорта.');
            }
        }
        
        // Проверить сохраненную смену при загрузке
        function checkStoredShift() {
            const lastPassport = localStorage.getItem('lastDriverPassport');
            if (lastPassport) {
                document.getElementById('driverPassport').value = lastPassport;
                checkShift();
            }
        }
        
        // Начать смену таксиста
        function startShift() {
            const name = document.getElementById('driverName').value;
            const middleName = document.getElementById('driverMiddleName').value;
            const passport = document.getElementById('driverPassport').value;
            const carType = document.getElementById('carType').value;
            const carBrand = document.getElementById('carBrand').value;
            const carModel = document.getElementById('carModel').value;
            const carColor = document.getElementById('carColor').value;
            const carNumber = document.getElementById('carNumber').value;
            
            if (!name || !middleName || !passport || !carBrand || !carModel || !carColor || !carNumber) {
                alert('Заполните все поля!');
                return;
            }
            
            // Проверяем, есть ли такой пользователь в банковской системе
            const player = players.find(p => p.passport === passport && p.name === name && p.middleName === middleName);
            if (!player) {
                alert('Ошибка: Ваши данные не найдены в банковской системе. Зарплата не будет начислена!');
                if (!confirm('Все равно начать смену?')) {
                    return;
                }
            }
            
            // Проверяем, не начата ли уже смена
            const existingShift = taxiData.activeDrivers.find(d => d.passport === passport);
            if (existingShift) {
                alert('У вас уже есть активная смена!');
                return;
            }
            
            // Добавляем таксиста в активные
            const driver = {
                name,
                middleName,
                passport,
                carType,
                carBrand,
                carModel,
                carColor,
                carNumber,
                startTime: new Date().toLocaleString(),
                calls: []
            };
            
            taxiData.activeDrivers.push(driver);
            saveTaxiData();
            
            // Сохраняем паспорт для последующей проверки
            localStorage.setItem('lastDriverPassport', passport);
            
            // Скрываем форму и показываем активную смену
            document.getElementById('shiftForm').style.display = 'none';
            document.getElementById('activeShift').style.display = 'block';
            
            // Обновляем информацию о смене
            document.getElementById('shiftInfo').innerHTML = `
                <p><strong>Таксист:</strong> ${name} ${middleName}</p>
                <p><strong>Паспорт:</strong> ${passport}</p>
                <p><strong>Автомобиль:</strong> ${carBrand} ${carModel}, ${carColor}, ${carNumber}</p>
                <p><strong>Начало смены:</strong> ${driver.startTime}</p>
            `;
            
            // Обновляем список вызовов
            updateDriverCalls();
            
            // Обновляем список таксистов у диспетчера
            updateDriverDropdown();
            updateDriversList();
            
            alert('Смена начата!');
        }
        
        // Завершить смену таксиста
        function endShift() {
            const passport = document.getElementById('driverPassport').value;
            
            if (confirm('Вы уверены, что хотите завершить смену?')) {
                // Сохраняем данные смены
                const driverIndex = taxiData.activeDrivers.findIndex(d => d.passport === passport);
                if (driverIndex !== -1) {
                    const driver = taxiData.activeDrivers[driverIndex];
                    driver.endTime = new Date().toLocaleString();
                    taxiData.shifts.push(driver);
                    taxiData.activeDrivers.splice(driverIndex, 1);
                    saveTaxiData();
                }
                
                // Удаляем сохраненный паспорт
                localStorage.removeItem('lastDriverPassport');
                
                // Показываем форму и скрываем активную смену
                document.getElementById('shiftForm').style.display = 'block';
                document.getElementById('activeShift').style.display = 'none';
                
                // Очищаем форму
                document.getElementById('driverName').value = '';
                document.getElementById('driverMiddleName').value = '';
                document.getElementById('driverPassport').value = '';
                document.getElementById('carBrand').value = '';
                document.getElementById('carModel').value = '';
                document.getElementById('carColor').value = '';
                document.getElementById('carNumber').value = '';
                
                // Обновляем список таксистов у диспетчера
                updateDriverDropdown();
                updateDriversList();
                
                alert('Смена завершена!');
            }
        }
        
        // Обновить вызовы таксиста
        function updateDriverCalls() {
            const passport = document.getElementById('driverPassport').value;
            const activeCallsList = document.getElementById('activeCallsList');
            const callsHistory = document.getElementById('callsHistory');
            
            if (!passport) return;
            
            // Активные вызовы
            const activeCalls = taxiData.calls.filter(call => 
                call.driverPassport === passport && call.status === 'assigned'
            );
            
            if (activeCalls.length === 0) {
                activeCallsList.innerHTML = '<p>Нет активных вызовов</p>';
            } else {
                activeCallsList.innerHTML = '<h4>Активные вызовы:</h4>';
                activeCalls.forEach(call => {
                    activeCallsList.innerHTML += `
                        <div class="call-item">
                            <p><strong>Клиент:</strong> ${call.callerName}</p>
                            <p><strong>Откуда:</strong> ${call.fromAddress}</p>
                            <p><strong>Куда:</strong> ${call.toAddress}</p>
                            <p><strong>Зарплата:</strong> ${call.salary} ₽</p>
                            <div class="call-actions">
                                <button onclick="completeCall('${call.id}')">Завершить вызов</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            // История вызовов
            const driverCalls = taxiData.calls.filter(call => 
                call.driverPassport === passport && call.status !== 'assigned'
            );
            
            if (driverCalls.length === 0) {
                callsHistory.innerHTML = '<p>Нет завершенных вызовов</p>';
            } else {
                callsHistory.innerHTML = '';
                driverCalls.forEach(call => {
                    let statusText = '';
                    if (call.status === 'completed') statusText = '<span class="status-badge status-completed">Ожидает подтверждения</span>';
                    if (call.status === 'approved') statusText = '<span class="status-badge status-approved">Одобрено</span>';
                    if (call.status === 'rejected') statusText = '<span class="status-badge status-rejected">Отклонено: ' + call.rejectReason + '</span>';
                    
                    callsHistory.innerHTML += `
                        <div class="completed-call">
                            <p><strong>Клиент:</strong> ${call.callerName}</p>
                            <p><strong>Откуда:</strong> ${call.fromAddress}</p>
                            <p><strong>Куда:</strong> ${call.toAddress}</p>
                            <p><strong>Зарплата:</strong> ${call.salary} ₽ ${statusText}</p>
                        </div>
                    `;
                });
            }
        }
        
        // Завершить вызов
        function completeCall(callId) {
            const callIndex = taxiData.calls.findIndex(c => c.id === callId);
            if (callIndex !== -1) {
                taxiData.calls[callIndex].status = 'completed';
                taxiData.calls[callIndex].completedTime = new Date().toLocaleString();
                saveTaxiData();
                updateDriverCalls();
                updateDispatcherCalls();
                alert('Вызов завершен! Ожидайте подтверждения диспетчера.');
            }
        }
        
        // Авторизация диспетчера
        function authDispatcher() {
            const password = document.getElementById('dispatcherPassword').value;
            if (password !== DISPATCHER_PASSWORD) {
                alert('Неверный пароль диспетчера!');
                return;
            }
            
            document.getElementById('dispatcherPanel').style.display = 'block';
            updateDriversList();
            updateDispatcherCalls();
        }
        
        // Обновить список таксистов у диспетчера
        function updateDriversList() {
            const driversList = document.getElementById('driversOnShift');
            
            if (taxiData.activeDrivers.length === 0) {
                driversList.innerHTML = '<p>Нет таксистов на смене</p>';
            } else {
                driversList.innerHTML = '';
                taxiData.activeDrivers.forEach(driver => {
                    driversList.innerHTML += `
                        <div class="driver-item">
                            <p><strong>Таксист:</strong> ${driver.name} ${driver.middleName}</p>
                            <p><strong>Паспорт:</strong> ${driver.passport}</p>
                            <p><strong>Автомобиль:</strong> ${driver.carBrand} ${driver.carModel}, ${driver.carColor}, ${driver.carNumber}</p>
                        </div>
                    `;
                });
            }
        }
        
        // Обновить dropdown с таксистами
        function updateDriverDropdown() {
            const driverDropdown = document.getElementById('assignDriver');
            driverDropdown.innerHTML = '<option value="">Выберите таксиста</option>';
            
            taxiData.activeDrivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.passport;
                option.textContent = `${driver.name} ${driver.middleName} (${driver.carBrand} ${driver.carModel})`;
                driverDropdown.appendChild(option);
            });
        }
        
        // Сгенерировать вызов
        function generateCall() {
            // Случайное имя клиента
            const callerName = clientNames[Math.floor(Math.random() * clientNames.length)];
            
            // Случайные адреса
            const fromAddressObj = addresses[Math.floor(Math.random() * addresses.length)];
            const fromHouse = fromAddressObj.houses[Math.floor(Math.random() * fromAddressObj.houses.length)];
            const fromAddress = `${fromAddressObj.street}, ${fromHouse}`;
            
            const toAddressObj = addresses[Math.floor(Math.random() * addresses.length)];
            const toHouse = toAddressObj.houses[Math.floor(Math.random() * toAddressObj.houses.length)];
            const toAddress = `${toAddressObj.street}, ${toHouse}`;
            
            // Базовая зарплата
            let salary = Math.floor(Math.random() * 1651) + 100; // от 100 до 1750
            
            // Увеличиваем в 4 раза если поездка за границу
            if (fromAddressObj.isBorder || toAddressObj.isBorder) {
                salary *= 4;
            }
            
            // Сохраняем сгенерированный вызов
            currentGeneratedCall = {
                callerName,
                fromAddress,
                toAddress,
                salary
            };
            
            // Заполняем форму
            document.getElementById('callerName').value = callerName;
            document.getElementById('fromAddress').value = fromAddress;
            document.getElementById('toAddress').value = toAddress;
            document.getElementById('callSalary').value = `${salary} ₽`;
        }
        
        // Создать вызов
        function createCall() {
            if (!currentGeneratedCall) {
                alert('Сначала сгенерируйте вызов!');
                return;
            }
            
            const driverPassport = document.getElementById('assignDriver').value;
            
            if (!driverPassport) {
                alert('Выберите таксиста!');
                return;
            }
            
            // Находим данные таксиста
            const driver = taxiData.activeDrivers.find(d => d.passport === driverPassport);
            if (!driver) {
                alert('Ошибка: таксист не найден!');
                return;
            }
            
            // Создаем вызов
            const call = {
                id: Date.now().toString(),
                callerName: currentGeneratedCall.callerName,
                fromAddress: currentGeneratedCall.fromAddress,
                toAddress: currentGeneratedCall.toAddress,
                salary: currentGeneratedCall.salary,
                driverName: `${driver.name} ${driver.middleName}`,
                driverPassport,
                carInfo: `${driver.carBrand} ${driver.carModel}, ${driver.carColor}, ${driver.carNumber}`,
                status: 'assigned',
                assignedTime: new Date().toLocaleString()
            };
            
            taxiData.calls.push(call);
            saveTaxiData();
            
            // Обновляем списки вызовов
            updateDispatcherCalls();
            
            // Генерируем новый вызов
            generateCall();
            document.getElementById('assignDriver').value = '';
            
            alert('Вызов создан и назначен таксисту!');
        }
        
        // Обновить список вызовов у диспетчера
        function updateDispatcherCalls() {
            const activeCallsList = document.getElementById('dispatcherCallsList');
            const completedCallsList = document.getElementById('completedCallsList');
            const approvedCallsList = document.getElementById('approvedCallsList');
            
            // Активные вызовы
            const activeCalls = taxiData.calls.filter(call => call.status === 'assigned');
            
            if (activeCalls.length === 0) {
                activeCallsList.innerHTML = '<p>Нет активных вызовов</p>';
            } else {
                activeCallsList.innerHTML = '';
                activeCalls.forEach(call => {
                    activeCallsList.innerHTML += `
                        <div class="dispatcher-call">
                            <p><strong>Клиент:</strong> ${call.callerName}</p>
                            <p><strong>Откуда:</strong> ${call.fromAddress}</p>
                            <p><strong>Куда:</strong> ${call.toAddress}</p>
                            <p><strong>Зарплата:</strong> ${call.salary} ₽</p>
                            <p><strong>Таксист:</strong> ${call.driverName} (${call.carInfo})</p>
                            <p><strong>Назначен:</strong> ${call.assignedTime}</p>
                        </div>
                    `;
                });
            }
            
            // Завершенные вызовы (ожидающие подтверждения)
            const completedCalls = taxiData.calls.filter(call => call.status === 'completed');
            
            if (completedCalls.length === 0) {
                completedCallsList.innerHTML = '<p>Нет завершенных вызовов</p>';
            } else {
                completedCallsList.innerHTML = '';
                completedCalls.forEach(call => {
                    completedCallsList.innerHTML += `
                        <div class="dispatcher-call">
                            <p><strong>Клиент:</strong> ${call.callerName}</p>
                            <p><strong>Откуда:</strong> ${call.fromAddress}</p>
                            <p><strong>Куда:</strong> ${call.toAddress}</p>
                            <p><strong>Зарплата:</strong> ${call.salary} ₽</p>
                            <p><strong>Таксист:</strong> ${call.driverName} (${call.carInfo})</p>
                            <p><strong>Завершен:</strong> ${call.completedTime}</p>
                            <div class="call-actions">
                                <button onclick="approveCall('${call.id}')">Одобрить</button>
                                <button onclick="rejectCall('${call.id}')" style="background-color: #e74c3c;">Отклонить</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            // История вызовов
            const approvedCalls = taxiData.calls.filter(call => call.status === 'approved' || call.status === 'rejected');
            
            if (approvedCalls.length === 0) {
                approvedCallsList.innerHTML = '<p>Нет истории вызовов</p>';
            } else {
                approvedCallsList.innerHTML = '';
                approvedCalls.forEach(call => {
                    let statusText = '';
                    if (call.status === 'approved') statusText = '<span class="status-badge status-approved">Одобрено: ' + call.approvedTime + '</span>';
                    if (call.status === 'rejected') statusText = '<span class="status-badge status-rejected">Отклонено: ' + call.rejectReason + '</span>';
                    
                    approvedCallsList.innerHTML += `
                        <div class="dispatcher-call">
                            <p><strong>Клиент:</strong> ${call.callerName}</p>
                            <p><strong>Откуда:</strong> ${call.fromAddress}</p>
                            <p><strong>Куда:</strong> ${call.toAddress}</p>
                            <p><strong>Зарплата:</strong> ${call.salary} ₽</p>
                            <p><strong>Таксист:</strong> ${call.driverName} (${call.carInfo})</p>
                            <p><strong>Статус:</strong> ${statusText}</p>
                        </div>
                    `;
                });
            }
        }
        
        // Одобрить вызов
        function approveCall(callId) {
            const callIndex = taxiData.calls.findIndex(c => c.id === callId);
            if (callIndex !== -1) {
                const call = taxiData.calls[callIndex];
                call.status = 'approved';
                call.approvedTime = new Date().toLocaleString();
                
                // Начисляем зарплату таксисту
                const driver = players.find(p => p.passport === call.driverPassport);
                if (driver) {
                    driver.balance += call.salary;
                    driver.history.unshift({
                        date: new Date().toLocaleString(),
                        amount: +call.salary,
                        description: `Оплата за вызов такси: ${call.callerName} (${call.fromAddress} -> ${call.toAddress})`
                    });
                    savePlayers();
                    renderPlayers();
                } else {
                    alert('Таксист не найден в банковской системе. Зарплата не начислена!');
                }
                
                saveTaxiData();
                updateDispatcherCalls();
                alert('Вызов одобрен! Зарплата начислена на счет таксиста.');
            }
        }
        
        // Отклонить вызов
        function rejectCall(callId) {
            const reason = prompt('Укажите причину отказа:');
            if (!reason) return;
            
            const callIndex = taxiData.calls.findIndex(c => c.id === callId);
            if (callIndex !== -1) {
                taxiData.calls[callIndex].status = 'rejected';
                taxiData.calls[callIndex].rejectReason = reason;
                taxiData.calls[callIndex].rejectedTime = new Date().toLocaleString();
                saveTaxiData();
                updateDispatcherCalls();
                alert('Вызов отклонен!');
            }
        }
    </script>
</body>
</html>